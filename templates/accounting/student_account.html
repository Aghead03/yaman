{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block content %}
<div class="header">
    <h2>حساب الطالب: {{ student.full_name }}</h2>
    <div class="actions">
        <a href="{% url 'accounting:add_payment' %}?student={{ student.id }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> إضافة دفعة
        </a>
    </div>
</div>

<div class="account-summary">
    <div class="stat-card">
        <div class="stat-info">
            <h3>إجمالي المطلوب</h3>
            <p>{{ total_required }} ل.س</p>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-info">
            <h3>إجمالي المدفوع</h3>
            <p>{{ total_paid }} ل.س</p>
        </div>
    </div>
    <div class="stat-card {% if balance > 0 %}balance-unpaid{% else %}balance-paid{% endif %}">
        <div class="stat-info">
            <h3>الرصيد</h3>
            <p>{{ balance }} ل.س</p>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-info">
            <h3>حالة الحساب</h3>
            <p>{% if is_paid_in_full %}مسدد بالكامل{% else %}غير مسدد{% endif %}</p>
        </div>
    </div>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>رقم الإيصال</th>
                <th>نوع الدفعة</th>
                <th>المبلغ المطلوب</th>
                <th>المبلغ المدفوع</th>
                <th>التاريخ</th>
                <th>طريقة الدفع</th>
                <th>الحالة</th>
                {% comment %} <th>تسديد</th> {% endcomment %}
            </tr>
        </thead>
        <tbody>
            {% for payment in payments %}
            <tr>
                <td>#{{ payment.id }}</td>
                <td>{{ payment.get_payment_type_display }}</td>
                <td>{{ payment.required_amount }} ل.س</td>
                <td>{{ payment.amount }} ل.س</td>
                <td>{{ payment.date|date:"Y-m-d" }}</td>
                <td>{{ payment.get_payment_method_display }}</td>
                <td>
                    <span class="badge {% if payment.is_full %}paid{% else %}pending{% endif %}">
                        {% if payment.is_full %}مسدد{% else %}جزئي{% endif %}
                    </span>
                </td>
                {% comment %} <td>
                    <a href="{% url 'accounting:settle_payment' %}?student={{ student.id }}" class="btn btn-primary">
                        <i class="fas fa-check"></i> تسديد الحساب
                    </a>
                </td> {% endcomment %}
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center">لا توجد دفعات مسجلة</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const paymentTypeSelect = document.getElementById('id_payment_type');
    const requiredAmountInput = document.getElementById('id_required_amount');
    
    if (paymentTypeSelect && requiredAmountInput) {
        paymentTypeSelect.addEventListener('change', function() {
            if (this.value === 'settlement') {
                // احسب الرصيد المتبقي تلقائياً (هذه القيمة يجب أن تحسب من الخادم)
                requiredAmountInput.readOnly = true;
                // هنا يمكنك إضافة كود لجلب الرصيد المتبقي من الخادم
            } else {
                requiredAmountInput.readOnly = false;
            }
        });
    }
});
</script>
{% endblock %}
{% endblock %}