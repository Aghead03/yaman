{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="header">
    <h2>النظام المالي</h2>
    <div class="actions">
        <div class="btn-group">
            <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-plus"></i> إضافة جديد
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{% url 'accounting:add_payment' %}">دفعة طالب</a></li>
                <li><a class="dropdown-item" href="{% url 'accounting:add_income' %}">وارد مالي</a></li>
                <li><a class="dropdown-item" href="{% url 'accounting:add_expense' %}">منصرف مالي</a></li>
            </ul>
        </div>
        <button id="exportFinance" class="btn btn-success">
            <i class="fas fa-file-export"></i> تصدير
        </button>
    </div>
</div>

<div class="tabs">
    <div class="tab {% if active_tab == 'students' %}active{% endif %}" data-tab="students">حسابات الطلاب</div>
    <div class="tab {% if active_tab == 'payments' %}active{% endif %}" data-tab="payments">سجل الدفعات</div>
    <div class="tab {% if active_tab == 'cash' %}active{% endif %}" data-tab="cash">حركة الصندوق</div>
    <div class="tab {% if active_tab == 'reports' %}active{% endif %}" data-tab="reports">التقارير المالية</div>
</div>

<div class="tab-content {% if active_tab == 'students' %}active{% endif %}" id="students">
    <div class="filters">
        <form method="get" id="studentsFilterForm">
            <div class="form-row">
                <div class="form-col">
                    <label>حالة الدفع:</label>
                    <select name="payment_status" class="form-control">
                        <option value="">الكل</option>
                        <option value="paid" {% if request.GET.payment_status == 'paid' %}selected{% endif %}>مسددون بالكامل</option>
                        <option value="unpaid" {% if request.GET.payment_status == 'unpaid' %}selected{% endif %}>غير مسددين</option>
                    </select>
                </div>
                <div class="form-col">
                    <button type="submit" class="btn btn-secondary">
                        <i class="fas fa-filter"></i> تصفية
                    </button>
                    <button type="button" id="resetStudentsFilters" class="btn btn-outline-secondary">
                        <i class="fas fa-undo"></i> إعادة تعيين
                    </button>
                </div>
            </div>
        </form>
    </div>
    
    <div class="table-container">
        <table id="studentsTable">
            <thead>
                <tr>
                    <th>اسم الطالب</th>
                    <th>إجمالي المطلوب</th>
                    <th>إجمالي المدفوع</th>
                    <th>الرصيد</th>
                    <th>الحالة</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr>
                    <td>{{ student.full_name }}</td>
                    <td>{{ student.total_required|default:0 }} ل.س</td>
                    <td>{{ student.total_paid|default:0 }} ل.س</td>
                    <td>{{ student.balance|default:0 }} ل.س</td>
                    <td>
                        <span class="badge {% if student.is_paid_in_full %}paid{% else %}unpaid{% endif %}">
                            {% if student.is_paid_in_full %}مسدد{% else %}غير مسدد{% endif %}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="{% url 'accounting:student_account' student.id %}" class="btn btn-sm btn-info" title="عرض الحساب">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{% url 'accounting:add_payment' %}?student={{ student.id }}" class="btn btn-sm btn-primary" title="إضافة دفعة">
                                <i class="fas fa-plus"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center">لا توجد نتائج</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="tab-content {% if active_tab == 'payments' %}active{% endif %}" id="payments">
    <div class="filters">
        <form method="get" id="paymentFilterForm">
            <div class="form-row">
                <div class="form-col">
                    <label>من تاريخ:</label>
                    <input type="date" name="from_date" class="form-control" value="{{ request.GET.from_date }}">
                </div>
                <div class="form-col">
                    <label>إلى تاريخ:</label>
                    <input type="date" name="to_date" class="form-control" value="{{ request.GET.to_date }}">
                </div>
                <div class="form-col">
                    <label>حالة الدفع:</label>
                    <select name="status" class="form-control">
                        <option value="">الكل</option>
                        <option value="paid" {% if request.GET.status == 'paid' %}selected{% endif %}>مسدد</option>
                        <option value="partial" {% if request.GET.status == 'partial' %}selected{% endif %}>جزئي</option>
                    </select>
                </div>
                <div class="form-col">
                    <button type="submit" class="btn btn-secondary">
                        <i class="fas fa-filter"></i> تصفية
                    </button>
                    <button type="button" id="resetPaymentFilters" class="btn btn-outline-secondary">
                        <i class="fas fa-undo"></i> إعادة تعيين
                    </button>
                </div>
            </div>
        </form>
    </div>
    
    <div class="table-container">
        <table id="paymentsTable">
            <thead>
                <tr>
                    <th>رقم الإيصال</th>
                    <th>الطالب</th>
                    <th>نوع الدفعة</th>
                    <th>المبلغ المطلوب</th>
                    <th>المبلغ المدفوع</th>
                    <th>تاريخ الدفع</th>
                    <th>طريقة الدفع</th>
                    <th>الحالة</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                {% for payment in payments %}
                <tr>
                    <td>#{{ payment.id }}</td>
                    <td>{{ payment.student.full_name }}</td>
                    <td>{{ payment.get_payment_type_display }}</td>
                    <td>{{ payment.required_amount }} ل.س</td>
                    <td>{{ payment.amount }} ل.س</td>
                    <td>{{ payment.date|date:"Y-m-d" }}</td>
                    <td>{{ payment.get_payment_method_display }}</td>
                    <td>
                        <span class="badge {% if payment.is_full %}paid{% else %}pending{% endif %}">
                            {% if payment.is_full %}مسدد{% else %}جزئي{% endif %}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="{% url 'accounting:receipt' payment.id %}" class="btn btn-sm btn-info" target="_blank" title="طباعة">
                                <i class="fas fa-print"></i>
                            </a>
                            <a href="{% url 'accounting:edit_payment' payment.id %}" class="btn btn-sm btn-warning" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn btn-sm btn-danger delete-payment" 
                                    data-id="{{ payment.id }}"
                                    data-url="{% url 'accounting:delete_payment' payment.id %}"
                                    title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center">لا توجد دفعات مسجلة</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="tab-content {% if active_tab == 'cash' %}active{% endif %}" id="cash">
    <div class="filters">
        <form method="get" id="cashFilterForm">
            <div class="form-row">
                <div class="form-col">
                    <label>من تاريخ:</label>
                    <input type="date" name="from_date" class="form-control" value="{{ request.GET.from_date }}">
                </div>
                <div class="form-col">
                    <label>إلى تاريخ:</label>
                    <input type="date" name="to_date" class="form-control" value="{{ request.GET.to_date }}">
                </div>
                <div class="form-col">
                    <label>النوع:</label>
                    <select name="type" class="form-control">
                        <option value="">الكل</option>
                        <option value="income" {% if request.GET.type == 'income' %}selected{% endif %}>وارد</option>
                        <option value="expense" {% if request.GET.type == 'expense' %}selected{% endif %}>منصرف</option>
                    </select>
                </div>
                <div class="filtered-stats">
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>الوارد المصفى</h3>
                            <p>{{ filtered_income }} ل.س</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>المنصرف المصفى</h3>
                            <p>{{ filtered_expenses }} ل.س</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>الرصيد المصفى</h3>
                            <p>{{ filtered_balance }} ل.س</p>
                        </div>
                    </div>
                </div>
                <div class="form-col">
                    <button type="submit" class="btn btn-secondary">
                        <i class="fas fa-filter"></i> تصفية
                    </button>
                    <button type="button" id="resetCashFilters" class="btn btn-outline-secondary">
                        <i class="fas fa-undo"></i> إعادة تعيين
                    </button>
                </div>
            </div>
        </form>
    </div>

    <div class="tab-content {% if active_tab == 'reports' %}active{% endif %}">
        <div class="stat-card">
            {% comment %} <div class="stat-icon" style="background-color: var(--secondary-color);">
                <i class="fas fa-money-bill-wave"></i>
            </div> {% endcomment %}
            <div class="stat-info">
                <h3>إجمالي الوارد</h3>
                <p>{{ total_income }} ل.س</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background-color: var(--danger-color);">
                <i class="fas fa-receipt"></i>
            </div>
            <div class="stat-info">
                <h3>إجمالي المنصرف</h3>
                <p>{{ total_expenses }} ل.س</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background-color: var(--info-color);">
                <i class="fas fa-wallet"></i>
            </div>
            <div class="stat-info">
                <h3>رصيد الصندوق</h3>
                <p>{{ cash_balance }} ل.س</p>
            </div>
        </div>
    </div>
    
    <div class="table-container">
        <table id="cashTable">
            <thead>
                <tr>
                    <th>التاريخ</th>
                    <th>النوع</th>
                    <th>المبلغ</th>
                    <th>الوصف</th>
                    <th>المستخدم</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                {% for transaction in transactions %}
                <tr>
                    <td>{{ transaction.date|date:"Y-m-d" }}</td>
                    <td>
                        <span class="transaction-type {% if transaction.type == 'income' %}type-income{% else %}type-expense{% endif %}">
                            {{ transaction.get_type_display }}
                        </span>
                    </td>
                    <td>{{ transaction.amount }} ل.س</td>
                    <td>{{ transaction.description }}</td>
                    <td>{{ transaction.user.username }}</td>
                    <td>
                        <div class="action-buttons">
                            <a href="{% url 'accounting:edit_transaction' transaction.id %}" class="btn btn-sm btn-warning" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn btn-sm btn-danger delete-transaction" 
                                    data-id="{{ transaction.id }}"
                                    data-url="{% url 'accounting:delete_transaction' transaction.id %}"
                                    title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center">لا توجد حركات مالية</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="tab-content" id="reports">
    <div class="chart-container">
        <canvas id="financeChart"></canvas>
    </div>
    
    <div class="report-summary">
        <div class="card">
            <div class="card-title">إجمالي الدفعات هذا الشهر</div>
            <div class="card-value">{{ monthly_payments.total }} ل.س</div>
            <div class="card-footer">
                <span>عدد الدفعات: {{ monthly_payments.count }}</span>
            </div>
        </div>
        <div class="card">
            <div class="card-title">حركة الصندوق الشهرية</div>
            <div class="card-value">{{ monthly_transactions.balance }} ل.س</div>
            <div class="card-footer">
                <span>وارد: {{ monthly_transactions.income }} ل.س</span>
                <span>منصرف: {{ monthly_transactions.expense }} ل.س</span>
            </div>
        </div>
        <div class="card">
            <div class="card-title">أعلى طالب مدفوعات</div>
            <div class="card-value">{{ top_student.name }}</div>
            <div class="card-footer">
                <span>المبلغ: {{ top_student.amount }} ل.س</span>
            </div>
        </div>
    </div>
    
    <div class="detailed-reports">
        <div class="report-card">
            <h3>إجمالي الوارد</h3>
            <p>{{ total_income }} ل.س</p>
        </div>
        <div class="report-card">
            <h3>إجمالي المنصرف</h3>
            <p>{{ total_expenses }} ل.س</p>
        </div>
        <div class="report-card">
            <h3>رصيد الصندوق</h3>
            <p>{{ cash_balance }} ل.س</p>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal" id="deleteModal">
    <div class="modal-content">
        <div class="modal-header">
            <h4>تأكيد الحذف</h4>
            <button class="close">&times;</button>
        </div>
        <div class="modal-body">
            <p id="deleteMessage">هل أنت متأكد من رغبتك في الحذف؟</p>
        </div>
        <div class="modal-footer">
            <form id="deleteForm" method="post">
                {% csrf_token %}
                <button type="button" class="btn btn-secondary close-btn">إلغاء</button>
                <button type="submit" class="btn btn-danger">حذف</button>
            </form>
        </div>
    </div>
</div>

<div class="modal" id="exportModal">
    <div class="modal-content">
        <div class="modal-header">
            <h4>تصدير البيانات</h4>
            <button class="close">&times;</button>
        </div>
        <div class="modal-body">
            {% comment %} <form id="exportForm" method="post" action="{% url 'accounting:export' %}"> {% endcomment %}
                {% csrf_token %}
                <div class="form-group">
                    <label>نوع التصدير:</label>
                    <select name="export_type" class="form-control">
                        <option value="excel">Excel</option>
                        <option value="pdf">PDF</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>الفترة الزمنية:</label>
                    <div class="form-row">
                        <div class="form-col">
                            <input type="date" name="from_date" class="form-control" placeholder="من تاريخ">
                        </div>
                        <div class="form-col">
                            <input type="date" name="to_date" class="form-control" placeholder="إلى تاريخ">
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary close-btn">إلغاء</button>
            <button type="submit" form="exportForm" class="btn btn-success">تصدير</button>
        </div>
    </div>
</div>
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // تبديل التبويبات
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    // تحديد التبويب النشط من URL أو استخدام القيمة الافتراضية
    const urlParams = new URLSearchParams(window.location.search);
    let activeTab = urlParams.get('tab') || 'students';
    
    // تفعيل التبويب والمحتوى النشطين عند التحميل
    tabs.forEach(tab => {
        if (tab.dataset.tab === activeTab) {
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
        }
    });
    
    // إضافة حدث النقر على التبويبات
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.getAttribute('data-tab');
            
            // تحديث عنوان URL بإضافة معلمة التبويب النشط
            const url = new URL(window.location);
            url.searchParams.set('tab', tabId);
            window.history.pushState({}, '', url);
            
            // إزالة النشاط من جميع التبويبات والمحتويات
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // إضافة النشاط للتبويب والمحتوى المحدد
            tab.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        });
    });

    // حذف الدفعة/المعاملة
    const deleteButtons = document.querySelectorAll('.delete-payment, .delete-transaction');
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const deleteUrl = this.getAttribute('data-url');
            document.getElementById('deleteForm').action = deleteUrl;
            document.getElementById('deleteModal').style.display = 'block';
        });
    });

    // إغلاق Modal
    const closeButtons = document.querySelectorAll('.close, .close-btn');
    closeButtons.forEach(button => {
        button.addEventListener('click', function() {
            document.getElementById('deleteModal').style.display = 'none';
            document.getElementById('exportModal').style.display = 'none';
        });
    });

    // فتح Modal التصدير
    document.getElementById('exportFinance').addEventListener('click', function() {
        document.getElementById('exportModal').style.display = 'block';
    });

    // إعادة تعيين الفلاتر
    document.getElementById('resetStudentsFilters').addEventListener('click', function() {
        document.getElementById('studentsFilterForm').reset();
        document.getElementById('studentsFilterForm').submit();
    });

    document.getElementById('resetPaymentFilters').addEventListener('click', function() {
        document.getElementById('paymentFilterForm').reset();
        document.getElementById('paymentFilterForm').submit();
    });

    document.getElementById('resetCashFilters').addEventListener('click', function() {
        document.getElementById('cashFilterForm').reset();
        document.getElementById('cashFilterForm').submit();
    });

    // إضافة معلمة التبويب إلى جميع نماذج التصفية
    const filterForms = document.querySelectorAll('form[id$="FilterForm"]');
    filterForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const activeTab = document.querySelector('.tab.active').dataset.tab;
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'tab';
            input.value = activeTab;
            this.appendChild(input);
        });
    });
    
    // إغلاق النافذة عند النقر خارجها
    window.addEventListener('click', function(event) {
        if (event.target === document.getElementById('deleteModal')) {
            document.getElementById('deleteModal').style.display = 'none';
        }
        if (event.target === document.getElementById('exportModal')) {
            document.getElementById('exportModal').style.display = 'none';
        }
    });
});

</script>
{% endblock %}


{% endblock %}


